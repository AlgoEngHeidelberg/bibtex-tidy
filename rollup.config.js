import commonjs from '@rollup/plugin-commonjs';
import nodeResolve from '@rollup/plugin-node-resolve';
import { version } from './package.json';
import { chmodSync, readFileSync, writeFileSync, mkdirSync } from 'fs';
import { join } from 'path';
import babel from '@rollup/plugin-babel';
import pegjs from 'pegjs';
import esbuild from 'esbuild';
import babelCore from '@babel/core';

const extensions = ['.ts', '.js'];

const SRC_PATH = join(__dirname, 'src');
const BUILD_PATH = join(SRC_PATH, '__generated__');

mkdirSync(BUILD_PATH, { recursive: true });

const banner = `/**
 * bibtex-tidy v${version}
 * https://github.com/FlamingTempura/bibtex-tidy
 *
 * DO NOT EDIT THIS FILE. This file is automatically generated
 * using \`npm run build\`. Edit files in './src' then rebuild.
 **/`;

const peg = readFileSync(join(SRC_PATH, 'bibtex.pegjs'), 'utf8');
const parser = pegjs.generate(peg, { output: 'source' });
writeFileSync(
	join(BUILD_PATH, 'bibtex.pegjs.js'),
	banner + '\nexport default ' + parser
);

function generateOptionTypes() {
	const { outputFiles } = esbuild.buildSync({
		entryPoints: [join(SRC_PATH, 'optionDefinitions.ts')],
		write: false,
		format: 'esm',
	});
	const bundle = new TextDecoder().decode(outputFiles[0].contents);
	// Bundle creates an export which eval doesn't know what to do with. Assign to
	// var instead.
	const options = eval(bundle.replace(/^export/m, 'const res = ') + '; res');

	const ts = [];

	ts.push(banner);
	ts.push('export type Options = {');
	for (const opt of options.optionDefinitions) {
		ts.push('\t/**');
		ts.push(`\t * ${opt.title}`);
		if (opt.description) {
			ts.push('\t *');
			for (const line of opt.description) {
				ts.push(`\t * ${line}`);
			}
		}
		ts.push('\t */');
		ts.push(`\t${opt.key}?: ${opt.type};`);
	}
	ts.push('};');
	ts.push('');

	writeFileSync(join(BUILD_PATH, 'optionsType.ts'), ts.join('\n'));
}

generateOptionTypes();

// For BigInt support:
// * No IE version supports BigInt
// * Edge 79+
// * Firefox 68+
// * Safari 14+
// * Chrome 67+
// All tested on browserstack. Bibtext tidy looks and works correctly.

const BROWSER_TARGETS = {
	edge: '79',
	firefox: '68',
	chrome: '67',
	safari: '14',
};

const cliOutFile = 'bin/bibtex-tidy';

esbuild.buildSync({
	bundle: true,
	platform: 'node',
	banner: { js: '#!/usr/bin/env node\n' + banner },
	outfile: cliOutFile,
	target: ['node7'],
	entryPoints: ['src/cli.ts'],
});

chmodSync(cliOutFile, 0o755); // rwxr-xr-x

const { outputFiles } = esbuild.buildSync({
	platform: 'browser',
	entryPoints: ['./docs/index.ts'],
	bundle: true,
	write: false,
	banner: { js: banner },
});
const bundle = outputFiles[0];

const result = babelCore.transform(bundle.text, {
	presets: [['@babel/env', { targets: BROWSER_TARGETS }]],
	compact: false,
});
if (!result?.code) throw new Error('No result from babel');
writeFileSync('docs/bundle.js', result.code);

export default [
	{
		input: 'src/index.ts',
		plugins: [
			commonjs(),
			nodeResolve({ extensions }),
			babel({
				extensions,
				babelHelpers: 'bundled',
				// see https://babeljs.io/docs/en/usage/#configuration
				presets: [
					'@babel/typescript',
					['@babel/env', { targets: BROWSER_TARGETS }],
				],
				comments: false,
			}),
		],
		output: {
			name: 'bibtexTidy',
			file: 'bibtex-tidy.js',
			format: 'umd',
			banner,
		},
	},
];
